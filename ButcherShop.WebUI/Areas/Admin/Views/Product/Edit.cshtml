@model ButcherShop.Entity.Entities.Product
@{
    ViewBag.Title = "Ürün Düzenle";
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="@Url.Action("Index")">Ürünler</a></li>
    <li class="breadcrumb-item active">Düzenle</li>
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title">Ürün Düzenle: @Model.Name</h3>
            </div>

            @using (Html.BeginForm("Edit", "Product", FormMethod.Post, new { @class = "form-horizontal" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(model => model.Id)
                @Html.HiddenFor(model => model.CreatedDate)
                @Html.HiddenFor(model => model.IsDeleted)

                <div class="card-body">
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                @Html.LabelFor(model => model.Name, "Ürün Adı *")
                                @Html.TextBoxFor(model => model.Name, new { @class = "form-control", required = "required" })
                                @Html.ValidationMessageFor(model => model.Name, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                @Html.LabelFor(model => model.CategoryId, "Kategori *")
                                @Html.DropDownList("CategoryId", (SelectList)ViewBag.Categories, "-- Kategori Seçin --", new { @class = "form-control", required = "required" })
                                @Html.ValidationMessageFor(model => model.CategoryId, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(model => model.Description, "Açıklama")
                        @Html.TextAreaFor(model => model.Description, new { @class = "form-control", rows = 4 })
                        @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                @Html.LabelFor(model => model.Price, "Fiyat (₺) *")
                                @Html.TextBox("Price", Model.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture), new { @class = "form-control", type = "number", step = "0.01", min = "0", required = "required" })
                                @Html.ValidationMessageFor(model => model.Price, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                @Html.LabelFor(model => model.Unit, "Birim")
                                @Html.TextBoxFor(model => model.Unit, new { @class = "form-control" })
                                @Html.ValidationMessageFor(model => model.Unit, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                @Html.LabelFor(model => model.StockQuantity, "Stok Miktarı")
                                @Html.TextBoxFor(model => model.StockQuantity, new { @class = "form-control", type = "number", min = "0" })
                                @Html.ValidationMessageFor(model => model.StockQuantity, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    @*<div class="form-group">
                            @Html.LabelFor(model => model.ImageUrl, "Görsel URL")
                            @Html.TextBoxFor(model => model.ImageUrl, new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.ImageUrl, "", new { @class = "text-danger" })
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <div class="mt-2">
                                    <img src="@Model.ImageUrl" alt="@Model.Name" class="img-thumbnail" style="max-width: 200px;" />
                                </div>
                            }
                        </div>*@

                    <div class="form-group">
                        @Html.LabelFor(model => model.ImageUrl, "Görsel URL")
                        @Html.TextBoxFor(model => model.ImageUrl, new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.ImageUrl, "", new { @class = "text-danger" })

                        @* ANA GÖRSEL ÖNİZLEMESİ - YENİ EKLEME *@
                        @{
                            var mainImageEdit = Model.ProductImages?.FirstOrDefault(pi => pi.IsMainImage && pi.IsActive && !pi.IsDeleted);
                            var displayImageUrlEdit = mainImageEdit?.ImageUrl ?? Model.ImageUrl;
                        }
                        @if (!string.IsNullOrEmpty(displayImageUrlEdit))
                        {
                            <div class="mt-2">
                                <label class="small text-muted">Mevcut Ana Görsel:</label>
                                <div class="position-relative" style="max-width: 300px;">
                                    <img src="@displayImageUrlEdit" alt="@Model.Name" class="img-thumbnail d-block" style="max-width: 100%;" />
                                    @if (mainImageEdit != null)
                                    {
                                        <span class="badge badge-primary position-absolute" style="top: 5px; right: 5px;">
                                            <i class="fas fa-star"></i> Ana Görsel
                                        </span>
                                    }
                                </div>
                                <a href="@Url.Action("Manage", "ProductImage", new { id = Model.Id })" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="fas fa-images"></i> Görselleri Yönet
                                </a>
                            </div>
                        }
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="custom-control custom-switch">
                                @Html.CheckBoxFor(model => model.IsFeatured, new { @class = "custom-control-input", id = "isFeaturedSwitch" })
                                <label class="custom-control-label" for="isFeaturedSwitch">
                                    <strong>Öne Çıkan Ürün</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="custom-control custom-switch">
                                @Html.CheckBoxFor(model => model.IsActive, new { @class = "custom-control-input", id = "isActiveSwitch" })
                                <label class="custom-control-label" for="isActiveSwitch">
                                    <strong>Aktif</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Güncelle
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="fas fa-times"></i> İptal
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}