@model List<ButcherShop.Entity.Entities.ContactMessage>
@{
    ViewBag.Title = "İletişim Mesajları";
    var filter = ViewBag.Filter as string ?? "all";
    var unreadCount = ViewBag.UnreadCount as int? ?? 0;
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")"><i class="fas fa-home"></i> Ana Sayfa</a></li>
    <li class="breadcrumb-item active">İletişim Mesajları</li>
}

<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Messages -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <i class="icon fas fa-check"></i>
                @TempData["Success"]
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <i class="icon fas fa-ban"></i>
                @TempData["Error"]
            </div>
        }

        <!-- Info Box -->
        @if (unreadCount > 0)
        {
            <div class="callout callout-danger">
                <h5><i class="fas fa-envelope"></i> Okunmamış Mesajlar</h5>
                <p>@unreadCount adet okunmamış mesajınız bulunmaktadır.</p>
            </div>
        }

        <!-- Main Card -->
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-envelope mr-2"></i>
                    İletişim Mesajları
                </h3>
                <div class="card-tools">
                    <span class="badge badge-primary">Toplam: @Model.Count</span>
                    @if (unreadCount > 0)
                    {
                        <span class="badge badge-danger ml-2">Okunmamış: @unreadCount</span>
                    }
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="card-header p-0 border-bottom-0">
                <ul class="nav nav-tabs" id="message-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link @(filter == "all" ? "active" : "")"
                           href="@Url.Action("Index", new { filter = "all" })">
                            <i class="fas fa-list"></i> Tümü
                            <span class="badge badge-secondary badge-pill ml-1">@Model.Count</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filter == "unread" ? "active" : "")"
                           href="@Url.Action("Index", new { filter = "unread" })">
                            <i class="fas fa-envelope"></i> Okunmamış
                            @if (unreadCount > 0)
                            {
                                <span class="badge badge-danger badge-pill ml-1">@unreadCount</span>
                            }
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filter == "read" ? "active" : "")"
                           href="@Url.Action("Index", new { filter = "read" })">
                            <i class="fas fa-envelope-open"></i> Okunmuş
                            <span class="badge badge-success badge-pill ml-1">@(Model.Count - unreadCount)</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                @if (Model.Any())
                {
                    <div class="table-responsive">
                        <table id="messagesTable" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 10px">#</th>
                                    <th>İsim</th>
                                    <th>E-posta</th>
                                    <th>Telefon</th>
                                    <th>Konu</th>
                                    <th>Mesaj</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                    <th style="width: 150px">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var message in Model)
                                {
                                    <tr class="@(!message.IsRead ? "table-warning" : "")">
                                        <td>@message.Id</td>
                                        <td>
                                            <strong>@message.Name</strong>
                                            @if (!message.IsRead)
                                            {
                                                <span class="badge badge-danger ml-1">Yeni</span>
                                            }
                                        </td>
                                        <td>
                                            <a href="mailto:@message.Email">
                                                <i class="fas fa-envelope mr-1"></i>@message.Email
                                            </a>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(message.Phone))
                                            {
                                                <a href="tel:@message.Phone">
                                                    <i class="fas fa-phone mr-1"></i>@message.Phone
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(message.Subject))
                                            {
                                                @message.Subject
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var preview = message.Message.Length > 50
                                                    ? message.Message.Substring(0, 50) + "..."
                                                    : message.Message;
                                            }
                                            <small>@preview</small>
                                        </td>
                                        <td>
                                            <small>
                                                <i class="far fa-clock mr-1"></i>
                                                @message.CreatedDate.ToString("dd.MM.yyyy HH:mm")
                                            </small>
                                        </td>
                                        <td>
                                            @if (message.IsRead)
                                            {
                                                <span class="badge badge-success">
                                                    <i class="fas fa-check"></i> Okundu
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-danger">
                                                    <i class="fas fa-envelope"></i> Okunmadı
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("Details", new { id = message.Id })"
                                                   class="btn btn-info"
                                                   title="Görüntüle">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                @using (Html.BeginForm("Delete", "ContactMessage", new { id = message.Id }, FormMethod.Post, new { @class = "d-inline", onsubmit = "return confirm('Bu mesajı silmek istediğinizden emin misiniz?');" }))
                                                {
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-danger" title="Sil">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="callout callout-info">
                        <h5><i class="fas fa-info"></i> Bilgi</h5>
                        <p>
                            @if (filter == "unread")
                            {
                                <text>Okunmamış mesaj bulunmuyor.</text>
                            }
                            else if (filter == "read")
                            {
                                <text>Okunmuş mesaj bulunmuyor.</text>
                            }
                            else
                            {
                                <text>Henüz hiç mesaj alınmadı.</text>
                            }
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

@section scripts {
    <script>
        $(function () {
            $('#messagesTable').DataTable({
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                "order": [[6, "desc"]], // Tarihe göre sıralama
                "pageLength": 25,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Turkish.json"
                },
                "buttons": [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success btn-sm'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn btn-danger btn-sm'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Yazdır',
                        className: 'btn btn-info btn-sm'
                    }
                ]
            }).buttons().container().appendTo('#messagesTable_wrapper .col-md-6:eq(0)');

            // Auto dismiss alerts after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>
}
